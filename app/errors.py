# app/errors.py
from __future__ import annotations
import re
from typing import Any, Mapping

# Повний список помилок ITTour -> UA пояснення
# (з урахуванням плейсхолдерів {field} {number} {number_from} {number_till} {length} {format} {date} {value} {int} {field2} {key})
ERROR_TIPS: dict[int, str] = {
    # 1xx: доступ / авторизація / ліміти
    100: "Доступ до API вимкнено (Access disabled). Перевірте, чи увімкнена послуга в ITTour для цього токена.",
    101: "Невірний або порожній токен (Bad token). Перевірте ITTOUR_API_TOKEN у .env і формат передачі токена.",
    102: "Метод HTTP запиту заборонений для цього endpoint (Method Not Allowed). Перевірте GET/POST у вашому запиті.",
    103: "Невірний endpoint або доступ до нього заборонений (Requested endpoint is forbidden). Перевірте URL.",
    104: "Запити з цього домену заборонені (Bad domain). Перевірте налаштування домену в ITTour.",
    105: "Послуга не активована (Service is not activated). Активуйте потрібний модуль/доступ у кабінеті ITTour.",
    106: "Запити з цього IP заборонені (Wrong IP). Додайте IP сервера у whitelist в ITTour.",
    107: "Пошук заблоковано (Search locked). Зверніться до підтримки ITTour або перевірте обмеження акаунту.",
    108: "Перевищено ліміт запитів за годину (Hour limit reached). Спробуйте пізніше.",
    109: "Перевищено ліміт запитів за день (Day limit reached). Спробуйте завтра або підвищіть ліміти.",
    110: "Невідома помилка ITTour (Unknown error). Спробуйте ще раз або змініть умови пошуку.",
    111: "Параметр flow_distributor порожній або не існує. Перевірте конфіг/налаштування інтеграції.",

    # 2xx: валідація параметрів
    200: "Поле {field} є обовʼязковим. Будь ласка, уточніть його і я повторю пошук.",
    201: "Поле {field} має бути цілим числом.",
    202: "Поле {field} має бути цілим числом і більшим за {number}.",
    203: "Поле {field} має бути цілим числом у діапазоні {number_from}–{number_till}.",
    204: "Значення поля {field} не знайдено у доступному списку. Уточніть, будь ласка.",
    205: "Поле {field} має бути цілим числом або масивом цілих чисел.",
    206: "Максимальна довжина поля {field} — {length} символів.",
    207: "Мінімальна довжина поля {field} — {length} символів.",
    208: "Поле {field} не є коректною email-адресою.",
    209: "Поле {field} має некоректний формат. Очікується {format}.",
    210: "Поле {field} не є реальною датою. Перевірте формат та значення.",
    211: "Поле {field} невалідне. Уточніть, будь ласка.",
    212: "Країна недоступна для пошуку. Оберіть іншу країну.",
    213: "Поле {field} містить некоректний ID.",
    214: "Поле {field} містить некоректний ID або недоступне для цих параметрів.",
    215: "Поле {field} не відповідає кількості дітей. Уточніть дітей та вік.",
    216: "Поле {field} має бути ≥ поля {field2}.",
    217: "Поле {field} має формат {format}.",
    218: "Поле {field} має формат {format}.",
    219: "Поле {field} має бути ≤ {value}.",
    220: "Поле {field} має бути ≥ {value}.",
    221: "Діапазон ночей завеликий. Максимум — {number} ночей. Зменшимо і повторимо пошук.",
    222: "Діапазон дат завеликий. Максимум — {number} днів. Скоротимо і повторимо пошук.",
    223: "Поле {field} не повинно містити більше {number} значень.",
    224: "Поле {field} має некоректний формат. Уточніть, будь ласка.",
    225: "Поле {field} має бути додатним числом.",

    # 3xx: туристи/паспорти
    300: "Турист №{number}: помилка в даних. Перевірте введену інформацію.",
    301: "Турист №{number}: поле {field} є обовʼязковим.",
    302: "Турист №{number}: максимальна довжина поля {field} — {length} символів.",
    303: "Турист №{number}: мінімальна довжина поля {field} — {length} символів.",
    304: "Турист №{number}: поле {field} має бути цілим числом.",
    305: "Турист №{number}: поле {field} не є коректною email-адресою.",
    306: "Турист №{number}: поле {field} має некоректний формат {format}.",
    307: "Турист №{number}: поле {field} не є реальною датою.",
    308: "Турист №{number}: поле {field} невалідне.",
    309: "Турист №{number}: вік має бути < {int}.",
    310: "Турист №{number}: вік має бути > {int}.",
    311: "Турист №{number}: вік має бути ≤ {int}.",
    312: "Турист №{number}: вік має бути ≥ {int}.",
    313: "Турист №{number}: дата дії паспорта має бути більшою за дату виїзду.",
    314: "Турист №{number}: дата дії паспорта має бути ≥ {value} для цього туру.",
    315: "Турист №{number}: паспорт має діяти щонайменше {int} місяців після завершення туру.",
    316: "Невірна кількість дорослих. Уточніть, будь ласка.",
    317: "Невірна кількість дітей. Уточніть, будь ласка.",
    318: "Невірна кількість немовлят. Уточніть, будь ласка.",
    319: "Туристів не знайдено.",
    320: "Не заповнені параметри туриста.",
    321: "Туриста не знайдено.",
    322: "Паспорти не знайдені.",
    323: "Редагування паспорта недоступне.",
    324: "Не знайдено паспортів, доступних для редагування.",
    325: "Помилка при редагуванні паспорта.",
    326: "ID паспорта {number}: поле {field} є обовʼязковим.",
    327: "ID паспорта {number}: максимальна довжина поля {field} — {length} символів.",
    328: "ID паспорта {number}: мінімальна довжина поля {field} — {length} символів.",
    329: "ID паспорта {number}: поле {field} має бути цілим числом.",
    330: "ID паспорта {number}: поле {field} не є коректною email-адресою.",
    331: "ID паспорта {number}: поле {field} має некоректний формат {format}.",
    332: "ID паспорта {number}: поле {field} не є реальною датою.",
    333: "ID паспорта {number}: поле {field} невалідне.",
    334: "ID паспорта {number}: вік має бути < {int}.",
    335: "ID паспорта {number}: вік має бути > {int}.",
    336: "ID паспорта {number}: вік має бути ≤ {int}.",
    337: "ID паспорта {number}: вік має бути ≥ {int}.",
    338: "ID паспорта {number}: дата дії паспорта має бути більшою за дату виїзду.",
    339: "ID паспорта {number}: дата дії паспорта має бути ≥ {value} для цього туру.",
    340: "ID паспорта {number}: паспорт має діяти щонайменше {int} місяців після завершення туру.",
    341: "ID паспорта {number}: не знайдено ID типу візи.",
    342: "ID паспорта {number}: не знайдено ID громадянства.",

    # 4xx: тури/бронювання/файли/інші
    400: "Тур не знайдено.",
    401: "Тур не актуальний.",
    402: "Тур не пакетний.",
    403: "Тур не знайдено або валідація неможлива.",
    404: "Ціну не знайдено. Спробуйте змінити валюту або бюджет.",
    405: "Невірна кількість немовлят.",
    406: "Перерахунок недоступний (Calc is not available).",
    407: "Дата підтвердження бронювання має бути більшою за сьогоднішню.",
    408: "Помилка створення запиту.",
    409: "Помилка створення заявки/замовлення.",
    410: "Ліміт зображень має відповідати формату {format}.",
    411: "Потрібні дані туристів.",
    412: "Потрібна інформація по договору агенції.",
    413: "Потрібен телефон туриста.",
    414: "Чартер не знайдено.",
    415: "Чартер не актуальний.",
    416: "Перельоти не знайдені.",
    417: "Помилка отримання інформації по чартеру.",
    418: "Фільтри порожні. Заповніть параметри пошуку.",
    419: "Неправильне громадянство.",
    420: "Готель не знайдено.",
    421: "Перевищено максимальну кількість готелів: {number}.",
    422: "Не задані public/private keys у налаштуваннях сервісу.",
    423: "ID заявки не знайдено.",
    424: "ID заявки {number} не знайдено.",
    425: "Перевищено максимальну кількість заявок: {number}.",
    426: "Тур не знайдено на ці дати.",
    427: "Дата вильоту {date} не знайдена для цього туру.",
    428: "Дублікат запиту (Duplicate request).",
    429: "Помилка створення туристів.",
    430: "Обраний тур не знайдено.",
    431: "Помилка створення обраного туру.",
    432: "Невірний ключ туру: {key} = {value}.",
    433: "Невірні дані екскурсійного туру, ключ: {key}.",
    434: "Некоректний ID заявки.",
    435: "Файл не знайдено.",
    436: "Формат файлу не підтримується.",
    437: "Порожні дані.",
    438: "Для країни ID {number} немає готельних фільтрів.",
    439: "Договір не знайдено.",
    440: "Агенцію не знайдено.",
    441: "Помилка створення транзакції.",
    442: "Дублікат транзакції.",
    443: "Перевищено кількість спроб для цього логіну. Спробуйте пізніше.",
    444: "Тип сервісу не знайдено.",
    445: "Користувача не знайдено або токен невалідний/прострочений.",
}

_DEFAULT_MSG = "Помилка сервера або параметрів. Спробуйте змінити умови пошуку."

def _extract_params_from_desc(desc: str) -> dict[str, str]:
    """
    Витягує значення з рядків типу:
      "Field hotel_rating must be integer and between 3 and 5"
    Це евристика. Якщо ITTour не дає структуровані поля — краще так, ніж нічого.
    """
    out: dict[str, str] = {}
    if not desc:
        return out

    # field
    m = re.search(r"Field\s+([a-zA-Z0-9_]+)", desc)
    if m:
        out["field"] = m.group(1)

    # numbers in text
    nums = re.findall(r"\d+", desc)
    if nums:
        # під різні шаблони
        if "number" not in out and len(nums) >= 1:
            out["number"] = nums[0]
        if len(nums) >= 2:
            out.setdefault("number_from", nums[0])
            out.setdefault("number_till", nums[1])
        if len(nums) >= 1:
            out.setdefault("int", nums[0])
            out.setdefault("length", nums[0])
            out.setdefault("value", nums[0])

    # format in quotes or after word format
    m = re.search(r"format\s+([^\s]+)", desc, flags=re.IGNORECASE)
    if m:
        out["format"] = m.group(1)

    # date
    m = re.search(r"Date\s+([0-9.\-\/]+)", desc)
    if m:
        out["date"] = m.group(1)

    return out

def humanize_error(code: int, payload: Any = None) -> str:
    """
    Повертає людське повідомлення по коду.
    payload можна передати (dict/str) — щоб підставити плейсхолдери.
    """
    msg_tpl = ERROR_TIPS.get(int(code or 0), _DEFAULT_MSG)

    # Якщо немає payload — просто повертаємо шаблон
    if payload is None:
        return msg_tpl

    # Спроба дістати error_desc (як у вашому прикладі)
    desc = ""
    if isinstance(payload, Mapping):
        desc = str(payload.get("error_desc") or payload.get("message") or "")
        # інколи буває вкладений error
        err = payload.get("error")
        if isinstance(err, Mapping):
            desc = desc or str(err.get("error_desc") or err.get("message") or "")
    elif isinstance(payload, str):
        desc = payload

    params = _extract_params_from_desc(desc)

    # Підстановка плейсхолдерів без падіння
    try:
        return msg_tpl.format(**params)
    except Exception:
        return msg_tpl
